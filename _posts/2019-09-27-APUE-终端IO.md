---
title: "APUE 终端I/O" 
layout: post
date: 2019-09-27 19:00
tag:
- terminal_io
category: apue
author: inotwant
description: APUE 终端I/O
---

## 终端I/O

注：以下内容是对  `APUE` 中终端I/O一章的理解和总结，请结合书中内容阅读！
#### 1 终端I/O的作用
1. 首先需要明确内核通过终端驱动程序控制终端的行为；
	- 比如，命令行下键入 `ctrl+C`，终端驱动程序会将 `SIGINT` 信号发送至当前会话前台前台进程组中的所有进程；
2. 显而易见，终端I/O最根本的需求就是对终端设备的读写；
3. 但是，为了适应不同的读写场合。此处的终端I/O，还应该包括通过系统调用(或库函数)与终端驱动程序交互来修改终端驱动程序控制终端的行为；
	- 直白的说，终端I/O可修改终端的行为，终端的属性。*而修改是由终端驱动程序代理的*；

#### 2 终端驱动程序中终端设备
1. 终端设备的逻辑结构
![终端设备的逻辑结构](https://raw.githubusercontent.com/INotWant/INotWant.github.io/master/assets/images/2019-09-28/Logical_picture_of_input_and_output_queues_for_a_terminal_device.png)
2. 终端行规程
	- 可认为从终端驱动程序中独立出来的一个模块，所有的终端驱动程序都能够一致地支持规范处理
	- 它与终端驱动程序的关系如下图
![终端设备的逻辑结构](https://raw.githubusercontent.com/INotWant/INotWant.github.io/master/assets/images/2019-09-28/Terminal_line_discipline.png)
3. 特殊输入字符
	- `POSIX.1` 定义了11个在输入时要特殊处理的字符 

#### 3 终端I/O中修改终端行为的操作
1. `termios` 结构体 --> 包含了所有可以更改或检测的终端特性
	- 输入标志
	- 输出标志
	- 控制标志
	- 本地标志（设置是否回显、设置允许模式等）
2. 具体操作（13个函数，4组）
	- 获取、设置属性（对应上述结构体中的一些标志）
	- 获取、设置输入、输出波特率
	- 行控制函数（挂起、恢复输出，冲洗输入、输出队列等）
	- 与前台进程组相关的操作

#### 4 终端I/O的两种工作模式 
1. 规范模式
	- 对终端输入以行为单位进行处理。发送一个读请求，当一行已经输入后，终端驱动程序即返回；
		-  所要求的字节数已读到
		-  读到一个行定界符
		-  捕捉到一个信号
	- 默认模式的模式。比如，shell 的重定向；
	- *注：这是终端IO的工作模式，前提是在终端读（`read(fd)` fd指向的是终端设备）；*
2. 非规范模式
	- 对终端输入以字符为单位进行处理；
		-  输入数据不装配成行，不处理一些特殊字符
	- 比如，`vim` 中的单字符命令

#### 5 其他
1. 使用 `ioctl`(文件操作百宝箱) 修改终端的大小
2. 支持终端典型操作（清屏、移动光标等）的一些库
	- `terminfo` `curses`
