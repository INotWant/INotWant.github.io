---
title: "APUE Socket" 
layout: post
date: 2019-09-14 19:06
tag:
- Socket
category: apue
author: inotwant
description: APUE 套接字综述
---

### Socket

Socket 用于：两个进程间的通信，该两个进程可以是本地的两个亦可以是远程的两个线程。

为了适应不同通信的特点，有多种 Socket 。大多数情况下，使用下面三个参数确定一种 Socket：
- 域 (例如，UNIX 域套接字、Internet 域套接字)
- 类型 (例如，Internet 域套接字下可分面向数据报的提供不可靠传输的`SOCK_DGRAM`、面向数据流的提供可靠传输的`SOCK_STREAAM`)
- 协议 (用作确定使用实现上述类型的哪种协议，通常使用默认值0)

这里主要总结 **Internet域套接字** 与 **UNIX域套接字**。

#### 1) Internet 域套接字

功能：常用于两个远程进程的通信。

UNIX 中一切皆文件，Socket 也不例外。通过调用 `socket()` 可得到一个描述该套接字的描述符。像操作文件描述符那样，可以拿同样的函数操作套接字描述符达到类似的目的。比如，使用 `read` `write` 进行读写操作。但是，套接字毕竟不是普通文件，它不具备普通文件的某些属性。比如，拥有者属性，所以就不能使用部分适用于文件的函数（比如，`chmod`）。当然，套接字也拥有自己独特的一些属性，这决定了有一部分函数专属于它。

详细介绍 Socket 如何实现进程间的通信之前，需要了解一下几个概念。

1. 字节序
    - 大端
    - 小端（最低有效位出现在低地址）
    - 网络协议，指定了字节序。（TCP/IP协议，使用大端序）
2. 地址
    - 该域中的 Socket 地址由：**主机名** + **端口号** 组成
    - 不同类型的 Socket 有不同的地址格式，为了统计接口，地址会被强转为 `struct socketaddr` 结构体
    - 地址相关的查询
        - 查询主机名
        - 查询服务（端口号）
        - 使用新的函数 `getaddrinfo()` `getnameinfo()`

如何使用 Socket 做进程间通信。

使用前，先使用 `bind()` 绑定地址(非必须，后续的某些操作能够自动绑定地址，比如 `connect`)。一种技巧，绑定是 IP 设置为 `INADDR_ANY` 这样便可将指定的端口绑定到多个 IP 上，便于为不同的网络提供服务。

接下来，由于使用的协议不同或角色不同（服务端、客户端）所执行的操作不同。不再详述这些过程，都挺简单的。只记录几个要点：
1. 阻塞操作可使用 **IO多路复用**（如 `select` `poll` 等)
    - `accept`，可读
    - `connect`，可写
2. 对于面向数据报的 write 调用无阻塞，因为它们实现没有相应的缓存区；而对它们的 read 无需搭配 while
3. 除了 read write 外，还有其他一些调用读写，它们能够设置一些标志指定一些行为
4. 其他
    - TCP 问题：某些平台，当第一次使用某 fd 去连接失败时，下次使用同一个 fd 去连接一定失败。所以，为了保证可移植性每次重连时重新构建一个 fd。
    - TCP 问题：除非超时，否则 TCP 的实现不允许绑定同一个地址。可以通过设置 `SO_REUSEADDR` 选项解决。

最后介绍关于 Internet 套接字的以下几个小点：
- 套接字选项，支持设置缓存区大小、超时值等等
- 带外数据(out-of-band data)，即紧急数据
- 类似文件描述符，可将套接字描述符设为非阻塞
- 异步 IO
    - 不同于通用的 AIO ，socket 的异步IO基于信号(`SIGIO`) 

#### 2) UNIX 域套接字

功能：用于本地的两个进程的通信。

特殊：可以 **传送文件描述符！**

- 匿名 UNIX 域套接字
- 命名 UNIX 域套接字
