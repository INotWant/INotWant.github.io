---
title: "APUE IPC" 
layout: post
date: 2019-08-30 16:06
tag:
- IPC
category: apue
author: inotwant
description: APUE IPC综述
---

### IPC
1. 管道
    - 特征
        - 1）创建一个管道产生两个文件描述符(它们在内核中相连)，一个用于读，另一个用于写
        - 2）由此，管道只允许在有共同祖先的进程中进行IPC
        - 3）通常指的是半双工管道，并且管道的两端都各自连接一个进程(多个的话一般使用 FIFO)
        - 4）*某种文件类型*
    - 读写
        - 读：当读一个已经关闭的管道(写端关闭)时，直到读完缓存区的内容，最后返回 0 表示 EOF
        - 写：当写一个已经关闭的管道(读端关闭)时，会收到 `SIGPIPE` 信号，返回-1，error 设为 `EPIPE`
            - **原子性**：写管道时，常量 `PIPE_BUF` 规定了内核管道缓存区大小，若每次写的内容小于该常量，则能保证写是原子性的。否则会出现分叉
    - 更简化的系统调用
        - popen --> 帮助根据指定参数(cmdstring)创建一个子进程，并将子进程的标准输入or输出使用管道连接到父进程的某文件描述符
        - pclose --> 等待子进程终止并得到相应的状态，最后关闭与之连接的父进程的文件描述符
    - 协同进程
        - 概念：当一个进程即读取某进程的作为输入，又将它的结果输出到那一进程，它便被称为协同进程
2. FIFO
    - 特征
        - 1）*某种文件类型*
        - 2）亦具备原子性
        - 3）先创建 FIFO 文件，然后读写时需要 open 它，它的读写端可以同时连接多个进程(可非阻塞读写，管道亦可以)
            - open 时因是否打开非阻塞标志而产生不同结果
        - 4）具备普通文件类似的权限
    - 读写
        - 读：读最后一个写进程关闭的FIFO，则该FIFO返回一个文件结束标志
        - 写：写一个无为读而打开的进程时，会收到 `SIGPIPE` 信号
    - *注：对 FIFO 而言，在最后一个引用 FIFO 的进程终止时，虽然 FIFO 的名字依然保留在系统中，直到显示地删除，但留在 FIFO 中的数据已被删除*
3. POSIX 信号量
    - 作用：解决了 XSI 信号量接口的几个缺陷
        - 1）删除了信号量集的概念
        - 2）删除信号量时不同于之前的直接删除，而是等待对该信号量的最后一个引用释放后
        - 3）性能的提高
    - 特征
        - 1）分为两种类型
            - 匿名 --> 在同一进程的多线程中或共享存储的多进程使用
            - 命名 --> 使用前需要 open
        - 2）具备权限控制
    - *技巧：打开一个信号量后接着断开它的连接，能简化进程结束时的清理*
4. XSI IPC
    - 共同特征
        - 1）标识符 & 键
        - 2）具备权限结构
        - 3）除非直接调用相应的删除，并不随所有进程的退出而消失，直到下一次启动
        - 4）**不使用文件描述符，所以不能对它们进行多路复用，很难一次使用一个以上这样的 IPC 结构(只能忙等)**
        - *注：使用时，注意一些系统的结构限制*
    - 信号量
        - 已被 POSIX  信号量代替
        - 唯一可提的是：`SEM_UNDO` 标志
    - 消息队列
        - 之前提出 消息队列 是为了提高一般速度的IPC，但现在其已经不占优势，因而在新的应用程序中不应当再使用它们
    - 共享存储
        - 与内容映射的不同：共享存储没有相关的文件，是内存的匿名段
        - 技巧(创建进程相关的共享存储)
            - 1）对 `/dev/zero` 的存储映射
            - 2）匿名存储映射
        - *附：一种利用，搭配互斥量等(线程同步的一些工具)做进程间同步*
5. 其他
    - 做互斥(同步)
        - 信号（需父子进程）
        - 信号量(XSI)
            - 可使用带 undo 的信号量做进程终止时的自动释放
            - 性能不咋地，但还复杂
        - 记录锁
            - 优点：进程终止后能够自动释放
            - 性能较好，简单，推荐
        - 互斥量
            - 说明：需要使用共享内存中的互斥量
            - 性能最好，但是缺点明显：*加锁下的进程异常终止时，其他进程不易恢复相应的信号量状态*

