---
title: "APUE 伪终端" 
layout: post
date: 2019-10-06 10:00
tag:
- pseudo_terminal pty
category: apue
author: inotwant
description: APUE 伪终端
---

## APUE 伪终端

注：以下内容是对  `APUE` 中第19章的理解和总结，请结合书中内容阅读！

#### 1 什么是伪终端

1. 所谓 `伪终端` 就是伪造的终端，但对应用程序而言它就像一个终端；**因而它的主要作用是模拟终端，通常作为一个回话的控制终端。**

2. 伪终端的结构分为两部分（见下图）

   - 伪终端主设备

   - 伪终端从设备

     ![伪终端的结构](https://raw.githubusercontent.com/INotWant/INotWant.github.io/master/assets/images/2019-10-06/pty_structure.png)

3. 伪终端的进一步说明

   - 因为是伪 **终端** ，所以操作终端的一些函数对它也是有效的
     - *注：因为是**伪**终端，所以一些函数虽可调用，但是无意义。比如，改变波特率等*
   - 伪终端主设备的输出作为伪终端从设备的输入，反之亦然
     - 从上图中可以看到伪终端可实现父子进程的通信
     - 这有点像双向管道，但它们不同之处在于：伪终端从设备上的**终端行规程**，这使得拥有普通管道上没有的其他处理能力
     - 关于终端行规程：在终端I/O那章有提到，可认为它是从终端设备驱动程序中抽离出来的模块，这使得对终端（包括伪终端）的输入、输出有统一规范的处理

4. 再次思考伪终端的作用

   - 从终端角度出发，终端通常有什么作用？
   - 从终端行规程出发，终端行规程有什么特性？
   - *注：伪终端的具体作用会在最后详细给出*

#### 2 伪终端的相关函数

1. 打开伪终端主设备
   - `posix_openpt()` 打开下一个可用的伪终端主设备
   - `grantpt(fd)` 更改伪终端从设备的权限（用户ID、组ID）。参数fd使用主设备的
   - `unlockpt(fd)` 调用该函数后才准许打开对应的伪终端从设备，方便在使用主、从设备前原子地初始化。参数fd使用主设备的
   - `pstname(fd)` 返回伪终端从设备的路径，可使用该路径打开伪终端从设备。参数fd使用主设备的
2. 打开伪终端从设备
   - `open(path)` 使用上述返回的伪终端从设备路径打开伪终端从设备
3. `pty_fork`
   - APUE 作者自写的函数
   - 功能：封装 `fork` 时 `pty` 的使用，使得 fork 产生的子进程将伪终端从设备作为新会话的控制终端

#### 3 伪终端的典型应用（图示请参考APUE）

1. 网络登录

   - 模拟终端

2. 窗口系统终端模拟

   - 模拟终端

3. `script` 程序

   - 功能：监控终端会话期间的所有输入和输出信息

   - 原理：从设备上的终端行规程的所有输出 -> 主设备的输入 -> 指定文件
   - **注：能监控输入信息是因为有回显，对于无回显的输入无法监控。比如，密码输入**

4. 运行协同进程

   - 协同进程的概念：进程A为进程B提供输入，然后进程A从进程B读取输出（双向管道），可把进程B看做进程A的 `协同进程`
   - 协同进程的要求：不能使用标准I/O库（缓存导致死锁）
   - 打破上述要求：中间添加伪终端，因为 `read` 从终端读取时最多读取一行

5. 非交互地驱动交互式程序

   - 原理：在 PTY 父进程中再启动一个进程（被称为驱动进程），该进程用于（间接）分析主设备的输出用于（间接）控制主设备的输入
   - 相关命令：`expect`

6. 观看长时间运行程序的输出

   - 问题：重定向使用的完全缓冲
   - 原理：使用伪终端，终端行规程是行缓冲