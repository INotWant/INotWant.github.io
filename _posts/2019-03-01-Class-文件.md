---
title: "Class 文件"
layout: post
date: 2019-03-01 22:00
tag:
- Class
- JVM
category: JVM
author: inotwant
description: 深入理解 Java 虚拟机第六章阅读笔记
---

## Class 文件

JVM 只与 `Class` 文件相关联。**字节码的描述能力要强于 Java 语言！**

### 一、Class 结构
1. 魔数
	- u4 --> `0xCAFEBABE`
2. 版本
	- u2 --> 小版本号
	- u2 --> JDK 1.1 为 45，后面依次加
	- 注意：高版本 JDK 编译出的 Class 文件，不能再低版本的 JDK 上执行
	- 兼容：针对上面问题，在高版本的编译时 javac ，可以考虑携带 `-target` `-source` 选项
3. 常量池
	- 格式：数量 + 内容
	- 注意：此处的索引从 1 开始，比如，数量为 22，则内容中含有（1~21）项。目的是把 0 索引留出来做特殊值用
	- 内容：1）字面量；2）符号引用[内容入口地址，动态链接]
4. 访问标志
	- 作用：（u2），主要是对类修饰符的描述，另外可以标志是否是枚举、注解、接口
5. 类索引
6. 父类索引
7. 接口索引集合
8. 字段表
	- 作用：修饰符 + 类型 + 字段名称
	- 区别
		1. 全限定名 --> `org/...`
		2. 简单名称 --> 就是名字
		3. 描述符 --> 1）字段（类型）；2）方法（返回值 + 参数）
	- 注意：字段表集合中不会列出从超类或父接口继承而来的字段
	- 附：`volatile` 变量在字节码中体现只有一个标志位！
9. 方法表
10. 属性表
	- 可以自定义
	- Code 属性表
		- 操作数栈最大深度 
		- 局部变量表的大小（slot）
		- 字节码的长度（JVM规范中明确规定不得超过 65535 条）
		- 使用异常表实现 --> `try-catch-finaly` 语义
	- Exceptions 属性表
		- 方法定义中描述的要 `throws` 的异常
	- LocalVariableTable 属性表
		- 作用：保存局部变量的名称（与 slot 想对应），可在 Class 中省略
		- 发现：可以看到方法的字节码中不包含局部变量的名称。
		- 附1：终端下调试 Java ，使用 `jdb`
		- 附2：姐妹属性 `LocalVariableTypeTable` 携带了泛型擦除的参数类型。如，`List<Integer>` 中 `Integer` 被擦除了
	- SourceFile 属性表
		- 作用：指定源码文件（内部类的 `class` 文件与源码文件不同名）
	- StackMapTable 属性表
		- 作用：记录方法的栈图（跳转字节码的偏移，局部变量，操作数栈），用于类加载字节码逻辑检查
	- Signature 属性表
		- 作用：记录泛型类型
	- BootstrapMethods 属性表
		- 作用：用于保存 `invokedynamic` 指令引用的引导方法限定符，要超前于 JDK1.7 的 `javac`
		- ？？
### 二、字节码指定类型

1. 加载与存储指令
2. 运算指令
3. 类型转换指令
4. 对象（包括数组）创建与访问指令
5. 操作数栈管理指令
6. 跳转指令
7. 异常处理指令
	- `athrow`
	- ~~`jsr`~~ & ~~`ret`~~
8. 同步指令
	- `monitorenter` & `monitorexit` 只用于 `synchronized` 块，`synchronized` 方法有标志